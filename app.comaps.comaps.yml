app-id: app.comaps.comaps
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: CoMaps
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --system-talk-name=org.freedesktop.GeoClue2.*

cleanup:
  - '*.a'
  - '/include'

modules:
  - name: optipng
    cleanup:
      - '*'
    sources:
     - type: archive
       url: https://prdownloads.sourceforge.net/optipng/optipng-7.9.1.tar.gz
       sha256: c2579be58c2c66dae9d63154edcb3d427fef64cb00ec0aff079c9d156ec46f29

  - name: python-protobuf
    buildsystem: simple
    cleanup:
      - '*'
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}" .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/55/5b/e3d951e34f8356e5feecacd12a8e3b258a1da6d9a03ad1770f28925f29bc/protobuf-3.20.3.tar.gz
        sha256: 2e3427429c9cffebf259491be0af70189607f365c2f41c7c3764af6f337105f2

  - name: comaps
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    post-install:
      - install -Dm644 "../qt/res/logo.png" "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png"
      - install -Dm644 "../qt/res/logo-scalable.svg" "${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.svg"
      - desktop-file-edit "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop" --set-icon=${FLATPAK_ID}
    sources:
      - type: git
        url: https://codeberg.org/comaps/comaps
        commit: bc36fd9975c350d64c44802db6586f07ce47b87a
        tag: v2026.02.09-4-Linux
      - type: patch
        path: ./disable-world-feed-integration-test.patch
      - type: file
        url: https://cdn-fi-1.comaps.app/maps/260207/World.mwm
        sha256: e923216282abbcd7bcb4e9736a300290de2b9ab7378627b786563762a6895994
        dest: data/world_mwm/260207/
      - type: file
        url: https://cdn-fi-1.comaps.app/maps/260207/WorldCoasts.mwm
        sha256: d04355c3873fd81800f348d780d012bb64544dc3bf0968a60c502c9a4aa6aad1
        dest: data/world_mwm/260207/
      - type: shell
        commands:
          - ./configure.sh
