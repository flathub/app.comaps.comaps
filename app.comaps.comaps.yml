app-id: app.comaps.comaps
runtime: org.kde.Platform
runtime-version: '6.10'
sdk: org.kde.Sdk
command: CoMaps
finish-args:
  - --share=network
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  - --device=dri
  - --system-talk-name=org.freedesktop.GeoClue2.*

cleanup:
  - '*.a'

modules:
  - name: optipng
    cleanup:
      - '*'
    sources:
     - type: archive
       url: https://prdownloads.sourceforge.net/optipng/optipng-7.9.1.tar.gz
       sha256: c2579be58c2c66dae9d63154edcb3d427fef64cb00ec0aff079c9d156ec46f29

  - name: python-protobuf
    buildsystem: simple
    cleanup:
      - '*'
    build-commands:
      - pip3 install --no-index --no-build-isolation --prefix="${FLATPAK_DEST}"
        .
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/55/5b/e3d951e34f8356e5feecacd12a8e3b258a1da6d9a03ad1770f28925f29bc/protobuf-3.20.3.tar.gz
        sha256: 2e3427429c9cffebf259491be0af70189607f365c2f41c7c3764af6f337105f2

  - name: comaps
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    cleanup:
      - '/include'
    post-install:
      - install -Dm644 "../qt/res/logo.png" "${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png"
      - desktop-file-edit "${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.desktop" --set-icon=${FLATPAK_ID}
    sources:
      - type: git
        url: https://codeberg.org/comaps/comaps
        commit: 95f58cea421a39ed072a3eba7601a9d4854a8d23
        tag: v2026.01.24-5
      - type: patch
        path: ./disable-world-feed-integration-test.patch
      - type: file
        url: https://cdn-fi-1.comaps.app/maps/260122/World.mwm
        sha256: 45522d0fbfc46091fb44ff99f14aaf867daa1ea674ce2c8998e99fc845a254c5 
        dest: data/world_mwm/260122/
      - type: file
        url: https://cdn-fi-1.comaps.app/maps/260122/WorldCoasts.mwm
        sha256: 81b0b934aa13536cf559a69c79e6ea9f53d262fc3daf1fa04397bfc5f32b1abb
        dest: data/world_mwm/260122/
      - type: shell
        commands:
          - ./configure.sh
